<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>语音实时识别</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #transcript {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 100px;
    }
    .info {
      margin-top: 10px;
      font-size: 14px;
    }
    button {
      margin-right: 10px;
    }
    #errorMessage {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>语音实时识别</h2>
  <button id="startBtn">开始识别</button>
  <button id="stopBtn" disabled>停止识别</button>
  <div id="timer" class="info">已识别时间：0 秒</div>
  <div id="charCount" class="info">字数：0</div>
  <div id="errorMessage"></div>
  <div id="transcript"></div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const transcriptDiv = document.getElementById("transcript");
    const timerDiv = document.getElementById("timer");
    const charCountDiv = document.getElementById("charCount");
    const errorMessageDiv = document.getElementById("errorMessage");

    let recognizing = false;
    let recognition;
    let errorCount = 0;
    let timer = null;
    let seconds = 0;
    let fullTranscript = "";

    function updateCharCount(text) {
      const count = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "").length;
      charCountDiv.textContent = "字数：" + count;
    }

    function startTimer() {
      timer = setInterval(() => {
        seconds++;
        timerDiv.textContent = "已识别时间：" + seconds + " 秒";
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timer);
    }

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("你的浏览器不支持语音识别，请使用最新版Chrome浏览器");
        return;
      }

      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = "zh-CN";

      recognition.onstart = () => {
        recognizing = true;
        console.log("识别已开始");
        errorMessageDiv.textContent = "";
      };

      recognition.onerror = (event) => {
        console.error("识别错误：", event.error);
        errorCount++;
        errorMessageDiv.textContent = "错误：" + event.error;

        if (event.error === "not-allowed" || event.error === "service-not-allowed") {
          alert("请允许麦克风访问");
          recognizing = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }

        if (event.error === "network") {
          alert("网络错误，请检查您的网络连接");
        }
      };

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            fullTranscript += event.results[i][0].transcript;
          } else {
            interim += event.results[i][0].transcript;
          }
        }
        transcriptDiv.textContent = fullTranscript + interim;
        updateCharCount(fullTranscript + interim);
      };

      recognition.onend = () => {
        console.log("识别已结束");
        if (recognizing && errorCount < 3) {
          setTimeout(() => {
            recognition.start();
          }, 1000); // 延迟1秒重新开始识别
        } else {
          recognizing = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
          stopTimer();
          if (errorCount >= 3) {
            alert("识别多次失败，已停止");
          }
        }
      };
    }

    startBtn.onclick = () => {
      fullTranscript = "";
      transcriptDiv.textContent = "";
      errorMessageDiv.textContent = "";
      seconds = 0;
      errorCount = 0;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      initRecognition();
      recognition.start();
      startTimer();
    };

    stopBtn.onclick = () => {
      recognizing = false;
      recognition.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;
      stopTimer();
    };
  </script>
</body>
</html>