<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿ç»­è¯­éŸ³è¯†åˆ«åŠ©æ‰‹</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background: #f0f2f5;
    }
    h1 {
      font-size: 1.8em;
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      font-size: 1em;
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #startBtn {
      background-color: #28a745;
    }
    #stopBtn {
      background-color: #dc3545;
    }
    #info {
      text-align: center;
      margin-top: 10px;
      font-size: 0.95em;
      color: #555;
    }
    #transcript {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      min-height: 150px;
      background: #fff;
      white-space: pre-wrap;
      border-radius: 5px;
    }
    .stats {
      margin-top: 10px;
      font-size: 0.95em;
      color: #444;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <h1>è¿ç»­è¯­éŸ³è¯†åˆ«åŠ©æ‰‹</h1>
  <div style="text-align:center;">
    <button id="startBtn">ğŸ¤ å¼€å§‹è¯†åˆ«</button>
    <button id="stopBtn" disabled>âœ‹ åœæ­¢è¯†åˆ«</button>
  </div>
  <div id="info">
    å¼€å§‹æ—¶é—´ï¼š<span id="startTime">--</span> |
    ç”¨æ—¶ï¼š<span id="timer">00:00</span> |
    å­—æ•°ï¼š<span id="charCount">0</span>
  </div>
  <div id="transcript" aria-live="polite"></div>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨ï¼Œå¦‚æ‰‹æœº Chrome");
    throw new Error("SpeechRecognition API not supported");
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'zh-CN';
  recognition.continuous = true;
  recognition.interimResults = true;

  let recognizing = false;
  let finalTranscript = '';
  let errorCount = 0;
  let timerInterval = null;
  let seconds = 0;

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const transcriptDiv = document.getElementById("transcript");
  const charCountSpan = document.getElementById("charCount");
  const timerSpan = document.getElementById("timer");
  const startTimeSpan = document.getElementById("startTime");

  const updateTimer = () => {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    timerSpan.textContent = `${m}:${s}`;
  };

  const countCharacters = (text) => {
    return text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "").length;
  };

  startBtn.onclick = () => {
    if (!recognizing) {
      finalTranscript = '';
      transcriptDiv.textContent = '';
      errorCount = 0;
      seconds = 0;
      timerSpan.textContent = "00:00";
      charCountSpan.textContent = "0";
      startTimeSpan.textContent = new Date().toLocaleTimeString();
      recognition.start();
    }
  };

  stopBtn.onclick = () => {
    if (recognizing) {
      recognizing = false;
      recognition.stop();
      clearInterval(timerInterval);
    }
  };

  recognition.onstart = () => {
    recognizing = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    timerInterval = setInterval(updateTimer, 1000);
    console.log("è¯†åˆ«å·²å¯åŠ¨");
  };

  recognition.onend = () => {
    console.log("è¯†åˆ«å·²ç»“æŸ");
    clearInterval(timerInterval);
    if (recognizing && errorCount < 3) {
      recognition.start();  // è‡ªåŠ¨é‡å¯
      console.log("é‡æ–°å¯åŠ¨è¯†åˆ«");
    } else {
      recognizing = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (errorCount >= 3) {
        alert("è¯†åˆ«å¤šæ¬¡å¤±è´¥ï¼Œå·²è‡ªåŠ¨åœæ­¢ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚");
      }
    }
  };

  recognition.onerror = (event) => {
    console.error("è¯†åˆ«é”™è¯¯ï¼š", event.error);
    errorCount++;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      alert("è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è¯†åˆ«");
      recognizing = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
    if (event.error === 'network') {
      alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥");
    }
  };

  recognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      let text = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += text;
      } else {
        interim += text;
      }
    }
    const fullText = finalTranscript + interim;
    transcriptDiv.textContent = fullText;
    charCountSpan.textContent = countCharacters(fullText);
  };
</script>
</body>
</html>