<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®æ—¶è¯­éŸ³è½¬æ–‡å­—å·¥å…·</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    button { font-size: 1.2em; padding: 10px 20px; margin-top: 10px; }
    #result { white-space: pre-wrap; margin-top: 20px; min-height: 100px; border: 1px solid #ccc; padding: 10px; }
    #stats { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>å®æ—¶è¯­éŸ³è½¬æ–‡å­—å·¥å…·</h1>
  <button id="startBtn">ğŸ¤ å¼€å§‹è¯†åˆ«</button>
  <button id="stopBtn" disabled>â¹ï¸ åœæ­¢è¯†åˆ«</button>
  <button id="copyBtn">ğŸ“‹ ä¸€é”®å¤åˆ¶</button>

  <div id="stats">
    æ–‡å­—å­—æ•°ï¼ˆä¸å«æ ‡ç‚¹ï¼‰ï¼š<span id="charCount">0</span> | â€œç‚¹å‡»â€å‡ºç°æ¬¡æ•°ï¼š<span id="clickCount">0</span> | è®¡æ—¶ï¼š<span id="timer">00:00</span>
  </div>

  <div id="result" aria-live="polite" aria-atomic="true"></div>

  <script>
    // å…¼å®¹SpeechRecognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨ã€‚");
      throw new Error("SpeechRecognition API not supported");
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "zh-CN";
    recognition.continuous = true;
    recognition.interimResults = true;

    let recognizing = false;
    let finalTranscript = "";
    let timerInterval = null;
    let secondsElapsed = 0;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const copyBtn = document.getElementById("copyBtn");
    const resultDiv = document.getElementById("result");
    const charCountSpan = document.getElementById("charCount");
    const clickCountSpan = document.getElementById("clickCount");
    const timerSpan = document.getElementById("timer");

    // æ­£åˆ™åŒ¹é…æ ‡ç‚¹ç¬¦å·ï¼ˆåŒ…æ‹¬ä¸­æ–‡ã€è‹±æ–‡æ ‡ç‚¹ï¼‰
    const punctuationRegex = /[\s`~!@#$%^&*()_\-+=\[\]{}|\\;:'",.<>\/?ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šâ€œâ€â€˜â€™ï¼ˆï¼‰ã€ã€‘ã€Šã€‹]/g;

    // è®¡æ—¶å™¨å‡½æ•°
    function startTimer() {
      secondsElapsed = 0;
      timerSpan.textContent = formatTime(secondsElapsed);
      timerInterval = setInterval(() => {
        secondsElapsed++;
        timerSpan.textContent = formatTime(secondsElapsed);
      }, 1000);
    }
    function stopTimer() {
      clearInterval(timerInterval);
    }
    function formatTime(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, "0");
      const s = String(sec % 60).padStart(2, "0");
      return `${m}:${s}`;
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats(text) {
      // å»é™¤æ ‡ç‚¹å’Œç©ºç™½ï¼Œè®¡ç®—å­—æ•°
      const cleanText = text.replace(punctuationRegex, "");
      charCountSpan.textContent = cleanText.length;

      // ç»Ÿè®¡â€œç‚¹å‡»â€å‡ºç°æ¬¡æ•°ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
      const clickMatches = text.match(/ç‚¹å‡»/gi);
      clickCountSpan.textContent = clickMatches ? clickMatches.length : 0;
    }

    recognition.onstart = () => {
      recognizing = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      startTimer();
      console.log("è¯­éŸ³è¯†åˆ«å·²å¼€å§‹");
    };

    recognition.onend = () => {
      recognizing = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      stopTimer();
      console.log("è¯­éŸ³è¯†åˆ«å·²åœæ­¢");
    };

    recognition.onerror = (event) => {
      console.error("è¯†åˆ«é”™è¯¯ï¼š", event.error);
      if (event.error === "not-allowed" || event.error === "service-not-allowed") {
        alert("è¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£æƒé™ï¼");
      }
      recognizing = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      stopTimer();
    };

    recognition.onresult = (event) => {
      let interimTranscript = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
        } else {
          interimTranscript += transcript;
        }
      }
      resultDiv.textContent = finalTranscript + interimTranscript;
      updateStats(finalTranscript + interimTranscript);
    };

    // ä¸ºäº†è§£å†³è¯´å®Œè¯è‡ªåŠ¨åœæ­¢çš„é—®é¢˜ï¼Œç»“æŸåè‡ªåŠ¨é‡å¯è¯†åˆ«
    recognition.onend = () => {
      if (recognizing) {
        recognition.start();
        console.log("è¯†åˆ«ç»“æŸï¼Œè‡ªåŠ¨é‡å¯");
      } else {
        stopTimer();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        console.log("è¯†åˆ«çœŸæ­£åœæ­¢");
      }
    };

    startBtn.addEventListener("click", () => {
      if (!recognizing) {
        finalTranscript = "";
        resultDiv.textContent = "";
        updateStats("");
        recognition.start();
      }
    });

    stopBtn.addEventListener("click", () => {
      if (recognizing) {
        recognizing = false;
        recognition.stop();
      }
    });

    copyBtn.addEventListener("click", () => {
      const text = resultDiv.textContent;
      if (!text) {
        alert("æ²¡æœ‰å¯å¤åˆ¶çš„æ–‡å­—");
        return;
      }
      navigator.clipboard.writeText(text).then(() => {
        alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
      }).catch(() => {
        alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
      });
    });
  </script>
</body>
</html>
