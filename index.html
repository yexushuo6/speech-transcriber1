<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>改进版实时连续语音听写</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
  button { font-size: 1.2em; padding: 10px 20px; margin: 5px; }
  #transcript { border: 1px solid #ccc; padding: 10px; min-height: 100px; white-space: pre-wrap; margin-top: 20px; }
</style>
</head>
<body>
  <h1>改进版实时连续语音听写</h1>
  <button id="startBtn">开始识别</button>
  <button id="stopBtn" disabled>停止识别</button>
  <div id="transcript" aria-live="polite"></div>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('抱歉，您的浏览器不支持语音识别，请使用Chrome浏览器');
    throw new Error('SpeechRecognition API 不支持');
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'zh-CN';
  recognition.continuous = true;
  recognition.interimResults = true;

  let recognizing = false;
  let finalTranscript = '';
  let errorCount = 0;  // 统计错误次数，避免死循环重启

  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const transcriptDiv = document.getElementById('transcript');

  startBtn.onclick = () => {
    if (!recognizing) {
      finalTranscript = '';
      transcriptDiv.textContent = '';
      recognition.start();
    }
  };

  stopBtn.onclick = () => {
    if (recognizing) {
      recognizing = false;
      recognition.stop();
    }
  };

  recognition.onstart = () => {
    recognizing = true;
    errorCount = 0;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    console.log('识别开始');
  };

  recognition.onend = () => {
    console.log('识别结束');
    if (recognizing) {
      if (errorCount < 3) {
        recognition.start();
        console.log('自动重启识别');
      } else {
        recognizing = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        alert('识别连续失败，已停止，请刷新页面后重试');
      }
    } else {
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  };

  recognition.onerror = (event) => {
    console.error('识别错误:', event.error);
    errorCount++;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      alert('请允许浏览器使用麦克风权限');
      recognizing = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    } else if (event.error === 'network') {
      alert('网络错误，请检查网络');
    }
  };

  recognition.onresult = (event) => {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      let transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript;
      } else {
        interimTranscript += transcript;
      }
    }
    transcriptDiv.textContent = finalTranscript + interimTranscript;
  };
</script>
</body>
</html>
