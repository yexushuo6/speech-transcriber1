<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿ç»­è¯­éŸ³è¯†åˆ«åŠ©æ‰‹</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #f8f9fa;
    }
    h1 {
      font-size: 1.5em;
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      font-size: 1em;
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #startBtn {
      background-color: #28a745;
    }
    #stopBtn {
      background-color: #dc3545;
    }
    #transcript {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      min-height: 120px;
      background: #fff;
      white-space: pre-wrap;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>è¿ç»­è¯­éŸ³è¯†åˆ«åŠ©æ‰‹</h1>
  <div style="text-align:center;">
    <button id="startBtn">ğŸ¤ å¼€å§‹è¯†åˆ«</button>
    <button id="stopBtn" disabled>âœ‹ åœæ­¢è¯†åˆ«</button>
  </div>
  <div id="transcript" aria-live="polite"></div>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨ï¼Œå¦‚æ‰‹æœº Chrome");
    throw new Error("SpeechRecognition API not supported");
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'zh-CN';
  recognition.continuous = true;
  recognition.interimResults = true;

  let recognizing = false;
  let finalTranscript = '';
  let errorCount = 0;
  let forceStop = false;

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const transcriptDiv = document.getElementById("transcript");

  startBtn.onclick = () => {
    if (!recognizing) {
      finalTranscript = '';
      transcriptDiv.textContent = '';
      errorCount = 0;
      forceStop = false;
      recognition.start();
    }
  };

  stopBtn.onclick = () => {
    if (recognizing) {
      forceStop = true;
      recognition.stop();
    }
  };

  recognition.onstart = () => {
    recognizing = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    console.log("è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨");
  };

  recognition.onend = () => {
    console.log("è¯­éŸ³è¯†åˆ«å·²ç»“æŸ");
    recognizing = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;

    if (!forceStop && errorCount < 5) {
      console.log("å°è¯•é‡æ–°å¯åŠ¨è¯†åˆ«...");
      setTimeout(() => recognition.start(), 300); // é¿å…ç«‹å³é‡å¯å¯¼è‡´å‡ºé”™
    } else if (errorCount >= 5) {
      alert("è¯†åˆ«å¤šæ¬¡å¤±è´¥ï¼Œå·²åœæ­¢ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•");
    }
  };

  recognition.onerror = (event) => {
    console.error("è¯†åˆ«é”™è¯¯ï¼š", event.error);
    errorCount++;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      alert("è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è¯†åˆ«");
      forceStop = true;
    } else if (event.error === 'network') {
      alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥");
    }
  };

  recognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      let text = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += text;
      } else {
        interim += text;
      }
    }
    transcriptDiv.textContent = finalTranscript + interim;
  };
</script>
</body>
</html>