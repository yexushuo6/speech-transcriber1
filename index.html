<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>连续语音识别助手</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      background: #f8f9fa;
    }
    h1 {
      font-size: 1.5em;
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      font-size: 1em;
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #startBtn {
      background-color: #28a745;
    }
    #stopBtn {
      background-color: #dc3545;
    }
    #transcript {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      min-height: 120px;
      background: #fff;
      white-space: pre-wrap;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>连续语音识别助手</h1>
  <div style="text-align:center;">
    <button id="startBtn">🎤 开始识别</button>
    <button id="stopBtn" disabled>✋ 停止识别</button>
  </div>
  <div id="transcript" aria-live="polite"></div>

<script>
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("当前浏览器不支持语音识别，请使用支持的浏览器，如手机 Chrome");
    throw new Error("SpeechRecognition API not supported");
  }

  const recognition = new SpeechRecognition();
  recognition.lang = 'zh-CN';
  recognition.continuous = true;
  recognition.interimResults = true;

  let recognizing = false;
  let finalTranscript = '';
  let errorCount = 0;
  let forceStop = false;

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const transcriptDiv = document.getElementById("transcript");

  startBtn.onclick = () => {
    if (!recognizing) {
      finalTranscript = '';
      transcriptDiv.textContent = '';
      errorCount = 0;
      forceStop = false;
      recognition.start();
    }
  };

  stopBtn.onclick = () => {
    if (recognizing) {
      forceStop = true;
      recognition.stop();
    }
  };

  recognition.onstart = () => {
    recognizing = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    console.log("语音识别已启动");
  };

  recognition.onend = () => {
    console.log("语音识别已结束");
    recognizing = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;

    if (!forceStop && errorCount < 5) {
      console.log("尝试重新启动识别...");
      setTimeout(() => recognition.start(), 300); // 避免立即重启导致出错
    } else if (errorCount >= 5) {
      alert("识别多次失败，已停止。请刷新页面重试");
    }
  };

  recognition.onerror = (event) => {
    console.error("识别错误：", event.error);
    errorCount++;
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      alert("请允许麦克风权限以使用语音识别");
      forceStop = true;
    } else if (event.error === 'network') {
      alert("网络错误，请检查您的网络连接");
    }
  };

  recognition.onresult = (event) => {
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      let text = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += text;
      } else {
        interim += text;
      }
    }
    transcriptDiv.textContent = finalTranscript + interim;
  };
</script>
</body>
</html>